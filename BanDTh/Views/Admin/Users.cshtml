@model IEnumerable<BanDTh.Models.User>
@{
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    ViewData["Title"] = "Qu·∫£n l√Ω t√†i kho·∫£n";
    var roles = ViewBag.Roles as IEnumerable<BanDTh.Models.Role> ?? Enumerable.Empty<BanDTh.Models.Role>();
}

<div class="container py-3">

    <!-- üîπ FORM T·∫†O T√ÄI KHO·∫¢N M·ªöI (·∫©n m·∫∑c ƒë·ªãnh) -->
    <div id="createForm" class="card shadow-sm mb-4" style="display:none;">
        <div class="card-body">
            <h5 class="mb-3 fw-bold text-success">+ T·∫°o t√†i kho·∫£n m·ªõi</h5>

            <form asp-action="CreateUser" method="post" class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">H·ªç v√† t√™n</label>
                    <input type="text" name="FullName" class="form-control" required />
                </div>

                <div class="col-md-6">
                    <label class="form-label">Email</label>
                    <input type="email" name="Email" class="form-control" required />
                </div>

                <div class="col-md-6">
                    <label class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
                    <input type="tel" name="PhoneNumber" class="form-control" pattern="[0-9]{10}" maxlength="10"
                           placeholder="VD: 0912345678" required />
                </div>

                <div class="col-md-6">
                    <label class="form-label">Gi·ªõi t√≠nh</label>
                    <select name="Gender" class="form-select" required>
                        <option value="Nam">Nam</option>
                        <option value="N·ªØ">N·ªØ</option>
                    </select>
                </div>

                <div class="col-md-6">
                    <label class="form-label">Vai tr√≤</label>
                    <select name="RoleId" class="form-select" required>
                        @foreach (var role in roles)
                        {
                            if (role.RoleName != "Customer")
                            {
                                <option value="@role.RoleId">@role.RoleName</option>
                            }
                        }
                    </select>
                </div>

                <div class="col-md-6">
                    <label class="form-label">M·∫≠t kh·∫©u</label>
                    <input type="password" name="Password" class="form-control" required />
                </div>

                <div class="col-md-6">
                    <label class="form-label">X√°c nh·∫≠n m·∫≠t kh·∫©u</label>
                    <input type="password" name="ConfirmPassword" class="form-control" required />
                </div>

                <div class="col-md-12 text-end">
                    <button type="submit" class="btn btn-success">T·∫°o t√†i kho·∫£n</button>
                    <button type="button" id="btnHideForm" class="btn btn-outline-secondary">H·ªßy</button>
                </div>
            </form>
        </div>
    </div>

    <!-- üß≠ Thanh c√¥ng c·ª• -->
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
        <button id="btnShowCreateForm" class="btn btn-success px-3">+ T·∫°o t√†i kho·∫£n m·ªõi</button>

        <form method="get" asp-controller="Admin" asp-action="Users" class="d-flex flex-wrap align-items-center gap-2">
            <select name="roleFilter" class="form-select" style="width:180px;">
                <option value="">-- L·ªçc theo vai tr√≤ --</option>
                @foreach (var r in roles)
                {
                    <option value="@r.RoleId">@r.RoleName</option>
                }
            </select>

            <input type="text" name="keyword" class="form-control" style="width:250px;"
                   placeholder="Nh·∫≠p t√™n ho·∫∑c email..." />

            <button type="submit" class="btn btn-dark">T√¨m ki·∫øm</button>
            <a asp-action="Users" class="btn btn-outline-secondary">Xem t·∫•t c·∫£</a>
        </form>
    </div>

    <!-- üìã Danh s√°ch t√†i kho·∫£n -->
    <div class="card shadow-sm border-0">
        <div class="card-body">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>#</th>
                        <th>H·ªç v√† t√™n</th>
                        <th>Email</th>
                        <th>Vai tr√≤</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th class="text-end">H√†nh ƒë·ªông</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model != null && Model.Any())
                    {
                        int i = 1;
                        foreach (var user in Model)
                        {
                            <tr id="user-row-@user.UserId">
                                <td>@i</td>
                                <td>@user.FullName</td>
                                <td>@user.Email</td>
                                <td><span class="badge bg-primary">@user.Role?.RoleName</span></td>
                                <td>
                                    <span class="status-text">@(user.IsActive ? "üü¢ Ho·∫°t ƒë·ªông" : "üî¥ Kho√°")</span>
                                </td>
                                <td class="text-end">
                                    <a asp-action="EditUser" asp-route-id="@user.UserId"
                                       class="btn btn-sm btn-outline-primary me-1">‚úèÔ∏è S·ª≠a</a>

                                    <button type="button"
                                            class="btn btn-sm toggle-lock @(user.IsActive ? "btn-outline-danger" : "btn-outline-success")"
                                            data-id="@user.UserId"
                                            data-status="@user.IsActive">
                                        @(user.IsActive ? "üîí Kho√°" : "üîì M·ªü kho√°")
                                    </button>
                                </td>
                            </tr>
                            i++;
                        }
                    }
                    else
                    {
                        <tr><td colspan="6" class="text-center text-muted py-3">Kh√¥ng c√≥ t√†i kho·∫£n n√†o.</td></tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<style>
.card { border-radius: 12px; border: none; }
form .form-label { font-weight: 500; }
.btn-success { background-color: #00b14f; border: none; }
.btn-success:hover { background-color: #009745; }
.table-hover tbody tr:hover { background-color: #f9f9f9; }
</style>

<script>
const createForm = document.getElementById("createForm");
document.getElementById("btnShowCreateForm").addEventListener("click", () => {
    createForm.style.display = "block";
    window.scrollTo({ top: 0, behavior: "smooth" });
});
document.getElementById("btnHideForm").addEventListener("click", () => {
    createForm.style.display = "none";
});

document.querySelectorAll(".toggle-lock").forEach(btn => {
    btn.addEventListener("click", async () => {
        const id = btn.dataset.id;

        const response = await fetch(`/Admin/ToggleUserStatus/${id}`, {
            method: "POST"
        });

        if (!response.ok) {
            alert("Kh√¥ng th·ªÉ thay ƒë·ªïi tr·∫°ng th√°i!");
            return;
        }

        const data = await response.json();
        const isActive = data.isActive;
        const row = document.getElementById(`user-row-${id}`);
        const statusText = row.querySelector(".status-text");

        // C·∫≠p nh·∫≠t giao di·ªán t·ª©c th√¨
        if (isActive) {
            btn.textContent = "üîí Kho√°";
            btn.classList.remove("btn-outline-success");
            btn.classList.add("btn-outline-danger");
            statusText.textContent = "üü¢ Ho·∫°t ƒë·ªông";
            btn.dataset.status = "true";
        } else {
            btn.textContent = "üîì M·ªü kho√°";
            btn.classList.remove("btn-outline-danger");
            btn.classList.add("btn-outline-success");
            statusText.textContent = "üî¥ Kho√°";
            btn.dataset.status = "false";
        }
    });
});

</script>
